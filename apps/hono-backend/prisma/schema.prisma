generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model categorias_entrada {
  id_categoria     BigInt     @id @default(autoincrement())
  id_evento        BigInt
  nombre           String     @db.VarChar(100)
  precio           Decimal    @db.Decimal(10, 2)
  stock_total      Int
  stock_disponible Int
  max_por_usuario  Int?       @default(4)
  eventos          eventos    @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
  reservas         reservas[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model cola_turnos {
  id_turno       BigInt       @id @default(autoincrement())
  id_cola        BigInt
  id_usuario     BigInt
  estado         String?      @default("esperando") @db.VarChar(20)
  posicion       Int
  fecha_ingreso  DateTime?    @default(now()) @db.Timestamptz(6)
  fecha_atencion DateTime?    @db.Timestamptz(6)
  colas_evento   colas_evento @relation(fields: [id_cola], references: [id_cola], onDelete: Cascade, onUpdate: NoAction)
  usuarios       usuarios     @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model colas_evento {
  id_cola          BigInt        @id @default(autoincrement())
  id_evento        BigInt
  max_concurrentes Int
  max_usuarios     Int
  fecha_creacion   DateTime?     @default(now()) @db.Timestamptz(6)
  cola_turnos      cola_turnos[]
  eventos          eventos       @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model entradas {
  id_entrada BigInt   @id @default(autoincrement())
  id_reserva BigInt
  codigo_qr  String   @unique @db.VarChar(255)
  estado     String?  @default("valida") @db.VarChar(20)
  reservas   reservas @relation(fields: [id_reserva], references: [id_reserva], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model estadisticas {
  id_estadistica       BigInt    @id @default(autoincrement())
  id_evento            BigInt
  total_vendidos       Int?      @default(0)
  total_cancelados     Int?      @default(0)
  total_ingresos       Decimal?  @default(0) @db.Decimal(12, 2)
  ultima_actualizacion DateTime? @default(now()) @db.Timestamptz(6)
  eventos              eventos   @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model eventos {
  id_evento          BigInt               @id @default(autoincrement())
  titulo             String               @db.VarChar(200)
  descripcion        String?
  ubicacion          String?              @db.VarChar(255)
  fecha_creacion     DateTime?            @default(now()) @db.Timestamptz(6)
  fecha_inicio_venta DateTime             @db.Timestamptz(6)
  fecha_fin_venta    DateTime             @db.Timestamptz(6)
  estado             String?              @default("oculto") @db.VarChar(20)
  categorias_entrada categorias_entrada[]
  colas_evento       colas_evento[]
  estadisticas       estadisticas[]
  fechas_evento      fechas_evento[]
  imagenes_evento    imagenes_evento[]
  logs_eventos       logs_eventos[]
  reservas           reservas[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model fechas_evento {
  id_fecha   BigInt     @id @default(autoincrement())
  id_evento  BigInt
  fecha_hora DateTime   @db.Timestamptz(6)
  eventos    eventos    @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
  reservas   reservas[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model imagenes_evento {
  id_imagen BigInt  @id @default(autoincrement())
  id_evento BigInt
  url       String  @db.VarChar(500)
  tipo      String? @default("galeria") @db.VarChar(20)
  eventos   eventos @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model logs_eventos {
  id_log     BigInt    @id @default(autoincrement())
  id_evento  BigInt
  id_usuario BigInt?
  accion     String    @db.VarChar(100)
  detalle    String?
  fecha      DateTime? @default(now()) @db.Timestamptz(6)
  eventos    eventos   @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
  usuarios   usuarios? @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model pagos {
  id_pago     BigInt    @id @default(autoincrement())
  id_reserva  BigInt
  metodo_pago String    @db.VarChar(50)
  monto_total Decimal   @db.Decimal(10, 2)
  estado      String?   @default("pendiente") @db.VarChar(20)
  fecha_pago  DateTime? @default(now()) @db.Timestamptz(6)
  reservas    reservas  @relation(fields: [id_reserva], references: [id_reserva], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model reservas {
  id_reserva         BigInt             @id @default(autoincrement())
  id_usuario         BigInt
  id_evento          BigInt
  id_fecha           BigInt
  id_categoria       BigInt
  cantidad           Int
  estado             String?            @default("pendiente") @db.VarChar(20)
  fecha_reserva      DateTime?          @default(now()) @db.Timestamptz(6)
  entradas           entradas[]
  pagos              pagos[]
  categorias_entrada categorias_entrada @relation(fields: [id_categoria], references: [id_categoria], onDelete: Cascade, onUpdate: NoAction)
  eventos            eventos            @relation(fields: [id_evento], references: [id_evento], onDelete: Cascade, onUpdate: NoAction)
  fechas_evento      fechas_evento      @relation(fields: [id_fecha], references: [id_fecha], onDelete: Cascade, onUpdate: NoAction)
  usuarios           usuarios           @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sesiones {
  id_sesion        BigInt    @id @default(autoincrement())
  id_usuario       BigInt
  token            String    @unique @db.VarChar(255)
  fecha_inicio     DateTime? @default(now()) @db.Timestamptz(6)
  fecha_expiracion DateTime  @db.Timestamptz(6)
  usuarios         usuarios  @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model usuarios {
  id_usuario     BigInt         @id @default(autoincrement())
  nombre         String         @db.VarChar(100)
  apellido       String         @db.VarChar(100)
  email          String         @unique @db.VarChar(150)
  password_hash  String         @db.VarChar(255)
  telefono       String?        @db.VarChar(20)
  rol            String?        @default("usuario") @db.VarChar(20)
  fecha_registro DateTime?      @default(now()) @db.Timestamptz(6)
  estado         String?        @default("activo") @db.VarChar(20)
  clerk_id       String?        @unique @db.VarChar(255) // Agregar campo para Clerk ID
  cola_turnos    cola_turnos[]
  logs_eventos   logs_eventos[]
  reservas       reservas[]
  sesiones       sesiones[]
}

enum EstadoReserva {
  PENDIENTE
  CONFIRMADA
  CANCELADA
}

enum EventoEstado {
  ACTIVO
  CANCELADO
  COMPLETADO
}
