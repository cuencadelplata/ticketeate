{
  "openapi": "3.0.3",
  "info": {
    "title": "Ticketeate API",
    "version": "1.0.0",
    "description": "Documentación de la API de Ticketeate (OAS 3.0)."
  },
  "servers": [
    { "url": "http://localhost:3000", "description": "Desarrollo local" }
  ],
  "tags": [
    { "name": "Admin" },
    { "name": "Auth" },
    { "name": "Compras" },
    { "name": "Cupones" },
    { "name": "Eventos" },
    { "name": "GitHub" },
    { "name": "Pagos (MercadoPago/Stripe)" },
    { "name": "Perfil" },
    { "name": "Cola de Tickets (Queue)" },
    { "name": "Revalidate" },
    { "name": "Tickets" },
    { "name": "Uploads" },
    { "name": "Usuarios" },
    { "name": "Vistas/Views" }
  ],
  "paths": {
    "/api/admin/views": {
      "get": {
        "tags": ["Admin"],
        "summary": "Listar/consultar vistas admin",
        "security": [{ "bearerAuth": [] }],
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "type": "object" } } } }
        }
      },
      "post": {
        "tags": ["Admin"],
        "summary": "Crear/actualizar vistas admin",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": {
          "200": { "description": "OK" }
        }
      }
    },

    "/api/auth/assign-role": {
      "post": {
        "tags": ["Auth"],
        "summary": "Asignar rol a usuario",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "userId": { "type": "string" }, "role": { "type": "string" } }, "required": ["userId","role"] } } } },
        "responses": { "200": { "description": "Rol asignado" } }
      }
    },
    "/api/auth/check-user": {
      "post": {
        "tags": ["Auth"],
        "summary": "Verificar usuario/credenciales",
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" }, "401": { "description": "No autorizado" } }
      }
    },
    "/api/auth/otp": {
      "post": {
        "tags": ["Auth"],
        "summary": "Solicitar/verificar OTP",
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/auth/password-reset": {
      "post": {
        "tags": ["Auth"],
        "summary": "Reset de contraseña",
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/auth/token": {
      "get": {
        "tags": ["Auth"],
        "summary": "Obtener token/estado",
        "responses": { "200": { "description": "OK" }, "401": { "description": "No autorizado" } }
      }
    },

    "/api/comprar": {
      "post": {
        "tags": ["Compras"],
        "summary": "Realizar compra de entradas",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "201": { "description": "Compra creada" }, "400": { "description": "Solicitud inválida" } }
      }
    },
    "/api/compras/historial": {
      "get": {
        "tags": ["Compras"],
        "summary": "Historial de compras del usuario",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" }, "401": { "description": "No autorizado" } }
      }
    },

    "/api/cupones": {
      "get": {
        "tags": ["Cupones"],
        "summary": "Obtener cupones (última versión por cupón) de un evento",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          {
            "name": "eventId",
            "in": "query",
            "required": true,
            "schema": { "type": "string" },
            "description": "ID del evento"
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "cupones": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "cuponid": { "type": "string" },
                          "eventoid": { "type": "string" },
                          "codigo": { "type": "string" },
                          "porcentaje_descuento": { "type": "number" },
                          "fecha_creacion": { "type": "string", "format": "date-time" },
                          "fecha_expiracion": { "type": "string", "format": "date-time" },
                          "limite_usos": { "type": "integer" },
                          "usos_actuales": { "type": "integer" },
                          "estado": { "type": "string" },
                          "version": { "type": "integer" },
                          "changed_at": { "type": "string", "format": "date-time" },
                          "changed_by": { "type": "string" },
                          "change_type": { "type": "string" }
                        }
                      }
                    }
                  }
                },
                "example": {
                  "cupones": [
                    {
                      "cuponid": "cup_123",
                      "eventoid": "evt_001",
                      "codigo": "EARLYBIRD",
                      "porcentaje_descuento": 20,
                      "fecha_creacion": "2025-10-01T10:00:00.000Z",
                      "fecha_expiracion": "2025-12-31T23:59:59.000Z",
                      "limite_usos": 100,
                      "usos_actuales": 5,
                      "estado": "ACTIVO",
                      "version": 3,
                      "changed_at": "2025-11-08T13:00:00.000Z",
                      "changed_by": "usr_abc",
                      "change_type": "UPDATE"
                    }
                  ]
                }
              }
            }
          },
          "400": { "description": "eventId es requerido" },
          "401": { "description": "No autorizado" },
          "403": { "description": "Sin permisos" },
          "500": { "description": "Error del servidor" }
        }
      },
      "post": {
        "tags": ["Cupones"],
        "summary": "Crear un nuevo cupón para un evento",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["eventId","codigo","porcentaje_descuento","fecha_expiracion","limite_usos"],
                "properties": {
                  "eventId": { "type": "string" },
                  "codigo": { "type": "string" },
                  "porcentaje_descuento": { "type": "number" },
                  "fecha_expiracion": { "type": "string", "format": "date-time" },
                  "limite_usos": { "type": "integer" }
                }
              },
              "example": {
                "eventId": "evt_001",
                "codigo": "EARLY2025",
                "porcentaje_descuento": 15,
                "fecha_expiracion": "2025-12-31T23:59:59.000Z",
                "limite_usos": 200
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Creado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": { "cupon": { "type": "object" } }
                },
                "example": {
                  "cupon": {
                    "cuponid": "cup_456",
                    "eventoid": "evt_001",
                    "codigo": "EARLY2025",
                    "porcentaje_descuento": 15,
                    "fecha_creacion": "2025-11-08T14:10:00.000Z",
                    "fecha_expiracion": "2025-12-31T23:59:59.000Z",
                    "limite_usos": 200,
                    "usos_actuales": 0,
                    "estado": "ACTIVO",
                    "version": 1,
                    "updated_by": "usr_abc"
                  }
                }
              }
            }
          },
          "400": { "description": "Faltan campos o duplicado" },
          "401": { "description": "No autorizado" },
          "403": { "description": "Sin permisos" },
          "500": { "description": "Error del servidor" }
        }
      },
      "patch": {
        "tags": ["Cupones"],
        "summary": "Actualizar un cupón (append-only history)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["cuponId","eventId"],
                "properties": {
                  "cuponId": { "type": "string" },
                  "eventId": { "type": "string" },
                  "codigo": { "type": "string" },
                  "porcentaje_descuento": { "type": "number" },
                  "fecha_expiracion": { "type": "string", "format": "date-time" },
                  "limite_usos": { "type": "integer" },
                  "estado": { "type": "string" }
                }
              },
              "example": {
                "cuponId": "cup_456",
                "eventId": "evt_001",
                "codigo": "EARLY2025-2",
                "porcentaje_descuento": 18,
                "fecha_expiracion": "2026-01-31T23:59:59.000Z",
                "limite_usos": 250,
                "estado": "ACTIVO"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Actualizado",
            "content": {
              "application/json": {
                "schema": { "type": "object", "properties": { "cupon": { "type": "object" } } },
                "example": {
                  "cupon": {
                    "cuponid": "cup_456",
                    "eventoid": "evt_001",
                    "codigo": "EARLY2025-2",
                    "porcentaje_descuento": 18,
                    "fecha_creacion": "2025-11-08T14:10:00.000Z",
                    "fecha_expiracion": "2026-01-31T23:59:59.000Z",
                    "limite_usos": 250,
                    "usos_actuales": 0,
                    "estado": "ACTIVO",
                    "version": 2,
                    "changed_by": "usr_abc",
                    "change_type": "UPDATE"
                  }
                }
              }
            }
          },
          "400": { "description": "cuponId/eventId requeridos o conflicto" },
          "401": { "description": "No autorizado" },
          "403": { "description": "Sin permisos" },
          "404": { "description": "No encontrado" },
          "500": { "description": "Error del servidor" }
        }
      },
      "delete": {
        "tags": ["Cupones"],
        "summary": "Eliminar (soft delete) un cupón",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "cuponId", "in": "query", "required": true, "schema": { "type": "string" } },
          { "name": "eventId", "in": "query", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": {
            "description": "Eliminado",
            "content": {
              "application/json": {
                "schema": { "type": "object", "properties": { "cupon": { "type": "object" } } },
                "example": {
                  "cupon": {
                    "cuponid": "cup_456",
                    "eventoid": "evt_001",
                    "codigo": "EARLY2025-2",
                    "porcentaje_descuento": 18,
                    "fecha_creacion": "2025-11-08T14:10:00.000Z",
                    "fecha_expiracion": "2026-01-31T23:59:59.000Z",
                    "limite_usos": 250,
                    "usos_actuales": 0,
                    "estado": "INACTIVO",
                    "version": 3,
                    "changed_by": "usr_abc",
                    "change_type": "DELETE"
                  }
                }
              }
            }
          },
          "400": { "description": "cuponId y eventId requeridos" },
          "401": { "description": "No autorizado" },
          "403": { "description": "Sin permisos" },
          "404": { "description": "No encontrado" },
          "500": { "description": "Error del servidor" }
        }
      }
    },

    "/api/cupones/validate": {
      "post": {
        "tags": ["Cupones"],
        "summary": "Validar cupón",
        "requestBody": { "content": { "application/json": { "schema": { "type": "object", "properties": { "code": { "type": "string" } }, "required": ["code"] } } } },
        "responses": { "200": { "description": "Válido/Inválido" } }
      }
    },

    "/api/generate-description": {
      "post": {
        "tags": ["Eventos"],
        "summary": "Generar descripción (AI) para evento",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/get-events": {
      "get": {
        "tags": ["Eventos"],
        "summary": "Listar eventos (servicio interno)",
        "parameters": [
          { "name": "q", "in": "query", "schema": { "type": "string" } },
          { "name": "category", "in": "query", "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/github/deploys": {
      "get": {
        "tags": ["GitHub"],
        "summary": "Listar deploys",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/github/workflows": {
      "get": {
        "tags": ["GitHub"],
        "summary": "Listar workflows",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/mercadopago/auth": {
      "get": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Auth de MercadoPago (redirect/estado)",
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/mercadopago/callback": {
      "get": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Callback de MercadoPago",
        "parameters": [
          { "name": "payment_id", "in": "query", "schema": { "type": "string" } },
          { "name": "status", "in": "query", "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/mercadopago/create-preference": {
      "post": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Crear preferencia de pago",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "201": { "description": "Creada" } }
      }
    },
    "/api/mercadopago/mock-callback": {
      "get": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Mock de callback (testing)",
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/profile": {
      "get": {
        "tags": ["Perfil"],
        "summary": "Obtener perfil",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" }, "401": { "description": "No autorizado" } }
      },
      "put": {
        "tags": ["Perfil"],
        "summary": "Actualizar perfil",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "Actualizado" } }
      }
    },
    "/api/profile/image": {
      "post": {
        "tags": ["Perfil"],
        "summary": "Subir/actualizar imagen de perfil",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "multipart/form-data": { "schema": { "type": "object", "properties": { "file": { "type": "string", "format": "binary" } } } } } },
        "responses": { "200": { "description": "OK" } }
      },
      "delete": {
        "tags": ["Perfil"],
        "summary": "Eliminar imagen de perfil",
        "security": [{ "bearerAuth": [] }],
        "responses": { "204": { "description": "Eliminada" } }
      }
    },

    "/api/queue": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Crear/abrir cola",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "201": { "description": "Creada" } }
      },
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Estado general de colas",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      },
      "delete": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Cerrar/eliminar cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "204": { "description": "Eliminada" } }
      }
    },
    "/api/queue/complete": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Completar atención en cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/queue/config": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Configurar cola",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      },
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Obtener config de cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      },
      "delete": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Eliminar config de cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "204": { "description": "Eliminada" } }
      }
    },
    "/api/queue/join": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Unirse a la cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/queue/leave": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Salir de la cola",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/queue/process": {
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Procesar la cola (tick)",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      },
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Obtener estado de procesamiento",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/queue/status": {
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Estado de la cola del usuario/evento",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/queue/stream": {
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Stream SSE/WebSocket de la cola",
        "responses": { "200": { "description": "OK (stream)" } }
      }
    },
    "/api/queue/worker": {
      "get": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Estado del worker",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      },
      "post": {
        "tags": ["Cola de Tickets (Queue)"],
        "summary": "Control del worker (start/stop/…)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/revalidate": {
      "post": {
        "tags": ["Revalidate"],
        "summary": "Solicitar revalidación de rutas",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      },
      "put": {
        "tags": ["Revalidate"],
        "summary": "Revalidación específica",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/stripe/create-session": {
      "post": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Crear sesión de pago (Stripe Checkout)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/stripe/verify-payment": {
      "get": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Verificar pago (Stripe)",
        "parameters": [
          { "name": "session_id", "in": "query", "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/stripe/webhook": {
      "post": {
        "tags": ["Pagos (MercadoPago/Stripe)"],
        "summary": "Webhook de Stripe",
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/tickets/enqueue": {
      "post": {
        "tags": ["Tickets"],
        "summary": "Encolar generación/envío de ticket",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "202": { "description": "Encolado" } }
      }
    },
    "/api/tickets/send-email": {
      "post": {
        "tags": ["Tickets"],
        "summary": "Enviar ticket por email",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "Enviado" } }
      }
    },

    "/api/upload-avatar": {
      "post": {
        "tags": ["Uploads"],
        "summary": "Subir avatar",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "multipart/form-data": { "schema": { "type": "object", "properties": { "file": { "type": "string", "format": "binary" } } } } } },
        "responses": { "201": { "description": "Subido" } }
      },
      "delete": {
        "tags": ["Uploads"],
        "summary": "Eliminar avatar",
        "security": [{ "bearerAuth": [] }],
        "responses": { "204": { "description": "Eliminado" } }
      }
    },

    "/api/user/role": {
      "post": {
        "tags": ["Usuarios"],
        "summary": "Asignar/cambiar rol de usuario",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object", "properties": { "userId": { "type": "string" }, "role": { "type": "string" } }, "required": ["userId","role"] } } } },
        "responses": { "200": { "description": "OK" } }
      }
    },

    "/api/views/{id}": {
      "parameters": [
        { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }
      ],
      "post": {
        "tags": ["Vistas/Views"],
        "summary": "Registrar/actualizar vista por id",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "content": { "application/json": { "schema": { "type": "object" } } } },
        "responses": { "200": { "description": "OK" } }
      },
      "get": {
        "tags": ["Vistas/Views"],
        "summary": "Obtener vista por id",
        "responses": { "200": { "description": "OK" }, "404": { "description": "No encontrado" } }
      }
    },
    "/api/views/{id}/history": {
      "get": {
        "tags": ["Vistas/Views"],
        "summary": "Histórico de vistas por id",
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/api/views/{id}/daily-sync": {
      "post": {
        "tags": ["Vistas/Views"],
        "summary": "Sincronizar vistas diarias por id",
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      },
      "get": {
        "tags": ["Vistas/Views"],
        "summary": "Obtener sync diario por id",
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": { "200": { "description": "OK" } }
      }
    }
  },
  "components": {
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": { "error": { "type": "string" } }
      }
    },
    "securitySchemes": {
      "bearerAuth": { "type": "http", "scheme": "bearer", "bearerFormat": "JWT" }
    }
  }
}
