
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Event {
  id          String         @id @default(cuid())
  title       String
  description String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?      // Soft delete
  version     Int           @default(1)
  isActive    Boolean       @default(true)
  categories  EventCategory[]
  tickets     Ticket[]
  producer    User          @relation(fields: [producerId], references: [id])
  producerId  String
  eventHistory EventHistory[] // Historial de cambios
}

model EventHistory {
  id          String    @id @default(cuid())
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id])
  title       String
  description String
  version     Int
  changedAt   DateTime  @default(now())
  changedBy   String    // ID del usuario que realizó el cambio
  changeType  ChangeType
}

model Category {
  id        String         @id @default(cuid())
  name      String        @unique
  createdAt DateTime      @default(now())
  deletedAt DateTime?     // Soft delete
  isActive  Boolean       @default(true)
  events    EventCategory[]
}

model EventCategory {
  event       Event     @relation(fields: [eventId], references: [id])
  eventId     String
  category    Category  @relation(fields: [categoryId], references: [id])
  categoryId  String
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // Soft delete
  isActive    Boolean   @default(true)

  @@id([eventId, categoryId])
}

model Ticket {
  id          String    @id @default(cuid())
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id])
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  status      TicketStatus
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // Soft delete
  isActive    Boolean   @default(true)
  version     Int       @default(1)
  ticketHistory TicketHistory[]
}

model TicketHistory {
  id          String    @id @default(cuid())
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id])
  status      TicketStatus
  version     Int
  changedAt   DateTime  @default(now())
  changedBy   String    // ID del usuario que realizó el cambio
  changeType  ChangeType
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete
  isActive  Boolean   @default(true)
  version   Int       @default(1)
  events    Event[]   // Eventos creados por el usuario
  tickets   Ticket[]  // Tickets comprados por el usuario
  userHistory UserHistory[]
}

model UserHistory {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  email     String
  name      String?
  version   Int
  changedAt DateTime  @default(now())
  changedBy String    // ID del usuario que realizó el cambio
  changeType ChangeType
}

enum ChangeType {
  CREATED
  UPDATED
  DELETED
}

enum TicketStatus {
  PENDING
  PAID
  CANCELLED
  USED
  EXPIRED
}
