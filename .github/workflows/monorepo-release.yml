name: Ticketeate Monorepo Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  detect-changes:
    name: Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      svc-users: ${{ steps.analyze.outputs.svc-users }}
      svc-events: ${{ steps.analyze.outputs.svc-events }}
      svc-producers: ${{ steps.analyze.outputs.svc-producers }}
      svc-checkout: ${{ steps.analyze.outputs.svc-checkout }}
      next-frontend: ${{ steps.analyze.outputs.next-frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze commits for changes
        id: analyze
        run: |
          echo "ðŸ” Analyzing commits for project changes..."
          
          # Obtener el Ãºltimo commit del push
          LAST_COMMIT=$(git log -1 --format="%H")
          PREV_COMMIT=$(git log -2 --format="%H" | tail -1)
          
          # Si es el primer commit, comparar con HEAD~1
          if [ -z "$PREV_COMMIT" ] || [ "$LAST_COMMIT" = "$PREV_COMMIT" ]; then
            PREV_COMMIT="HEAD~1"
          fi
          
          echo "Comparing $PREV_COMMIT...$LAST_COMMIT"
          
          # Obtener archivos cambiados
          CHANGED_FILES=$(git diff --name-only $PREV_COMMIT $LAST_COMMIT 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Obtener commits recientes para anÃ¡lisis de scope
          COMMITS=$(git log --oneline -10 --format="%s")
          echo ""
          echo "Recent commits:"
          echo "$COMMITS"
          
          # Detectar cambios por archivos O por scope en commits
          if echo "$CHANGED_FILES" | grep -q "apps/svc-users" || echo "$COMMITS" | grep -qE "(feat|fix|perf|refactor)\(svc-users\)"; then
            echo "svc-users=true" >> $GITHUB_OUTPUT
            echo "âœ… svc-users: changes detected"
          else
            echo "svc-users=false" >> $GITHUB_OUTPUT
            echo "âŒ svc-users: no changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "apps/svc-events" || echo "$COMMITS" | grep -qE "(feat|fix|perf|refactor)\(svc-events\)"; then
            echo "svc-events=true" >> $GITHUB_OUTPUT
            echo "âœ… svc-events: changes detected"
          else
            echo "svc-events=false" >> $GITHUB_OUTPUT
            echo "âŒ svc-events: no changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "apps/svc-producers" || echo "$COMMITS" | grep -qE "(feat|fix|perf|refactor)\(svc-producers\)"; then
            echo "svc-producers=true" >> $GITHUB_OUTPUT
            echo "âœ… svc-producers: changes detected"
          else
            echo "svc-producers=false" >> $GITHUB_OUTPUT
            echo "âŒ svc-producers: no changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "apps/svc-checkout" || echo "$COMMITS" | grep -qE "(feat|fix|perf|refactor)\(svc-checkout\)"; then
            echo "svc-checkout=true" >> $GITHUB_OUTPUT
            echo "âœ… svc-checkout: changes detected"
          else
            echo "svc-checkout=false" >> $GITHUB_OUTPUT
            echo "âŒ svc-checkout: no changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "apps/next-frontend" || echo "$COMMITS" | grep -qE "(feat|fix|perf|refactor)\(next-frontend\)"; then
            echo "next-frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… next-frontend: changes detected"
          else
            echo "next-frontend=false" >> $GITHUB_OUTPUT
            echo "âŒ next-frontend: no changes"
          fi

  release-svc-users:
    name: Release svc-users
    needs: detect-changes
    if: needs.detect-changes.outputs.svc-users == 'true'
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new-version }}
      has-release: ${{ steps.semantic.outputs.has-release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.10.0

      - name: Install semantic-release globally
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/git

      - name: Run semantic-release
        id: semantic
        working-directory: apps/svc-users
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release > release-output.txt 2>&1 || true
          cat release-output.txt
          
          if grep -q "Published release" release-output.txt || grep -q "Created tag" release-output.txt; then
            echo "has-release=true" >> $GITHUB_OUTPUT
            VERSION=$(git tag -l "svc-users-v*" --sort=-v:refname | head -n 1 | sed 's/svc-users-v//')
            echo "new-version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release created: v$VERSION"
          else
            echo "has-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No release created"
          fi

  release-svc-events:
    name: Release svc-events
    needs: detect-changes
    if: needs.detect-changes.outputs.svc-events == 'true'
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new-version }}
      has-release: ${{ steps.semantic.outputs.has-release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.10.0

      - name: Install semantic-release globally
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/git

      - name: Run semantic-release
        id: semantic
        working-directory: apps/svc-events
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release > release-output.txt 2>&1 || true
          cat release-output.txt
          
          if grep -q "Published release" release-output.txt || grep -q "Created tag" release-output.txt; then
            echo "has-release=true" >> $GITHUB_OUTPUT
            VERSION=$(git tag -l "svc-events-v*" --sort=-v:refname | head -n 1 | sed 's/svc-events-v//')
            echo "new-version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release created: v$VERSION"
          else
            echo "has-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No release created"
          fi

  release-svc-producers:
    name: Release svc-producers
    needs: detect-changes
    if: needs.detect-changes.outputs.svc-producers == 'true'
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new-version }}
      has-release: ${{ steps.semantic.outputs.has-release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.10.0

      - name: Install semantic-release globally
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/git

      - name: Run semantic-release
        id: semantic
        working-directory: apps/svc-producers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release > release-output.txt 2>&1 || true
          cat release-output.txt
          
          if grep -q "Published release" release-output.txt || grep -q "Created tag" release-output.txt; then
            echo "has-release=true" >> $GITHUB_OUTPUT
            VERSION=$(git tag -l "svc-producers-v*" --sort=-v:refname | head -n 1 | sed 's/svc-producers-v//')
            echo "new-version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release created: v$VERSION"
          else
            echo "has-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No release created"
          fi

  release-svc-checkout:
    name: Release svc-checkout
    needs: detect-changes
    if: needs.detect-changes.outputs.svc-checkout == 'true'
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new-version }}
      has-release: ${{ steps.semantic.outputs.has-release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.10.0

      - name: Install semantic-release globally
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/git

      - name: Run semantic-release
        id: semantic
        working-directory: apps/svc-checkout
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release > release-output.txt 2>&1 || true
          cat release-output.txt
          
          if grep -q "Published release" release-output.txt || grep -q "Created tag" release-output.txt; then
            echo "has-release=true" >> $GITHUB_OUTPUT
            VERSION=$(git tag -l "svc-checkout-v*" --sort=-v:refname | head -n 1 | sed 's/svc-checkout-v//')
            echo "new-version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release created: v$VERSION"
          else
            echo "has-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No release created"
          fi

  release-next-frontend:
    name: Release next-frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.next-frontend == 'true'
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.semantic.outputs.new-version }}
      has-release: ${{ steps.semantic.outputs.has-release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm@10.10.0

      - name: Install semantic-release globally
        run: npm install -g semantic-release @semantic-release/changelog @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/exec @semantic-release/git

      - name: Run semantic-release
        id: semantic
        working-directory: apps/next-frontend
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release > release-output.txt 2>&1 || true
          cat release-output.txt
          
          if grep -q "Published release" release-output.txt || grep -q "Created tag" release-output.txt; then
            echo "has-release=true" >> $GITHUB_OUTPUT
            VERSION=$(git tag -l "next-frontend-v*" --sort=-v:refname | head -n 1 | sed 's/next-frontend-v//')
            echo "new-version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release created: v$VERSION"
          else
            echo "has-release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No release created"
          fi

  # Docker build jobs
  docker-svc-users:
    name: Build & Push svc-users Docker
    needs: release-svc-users
    if: needs.release-svc-users.outputs.has-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ticketeate-svc-users
          IMAGE_TAG: ${{ needs.release-svc-users.outputs.new-version }}
        run: |
          echo "ðŸ³ Building Docker image for svc-users:$IMAGE_TAG"
          docker build \
            -f apps/svc-users/Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          echo "ðŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Successfully pushed:"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  docker-svc-events:
    name: Build & Push svc-events Docker
    needs: release-svc-events
    if: needs.release-svc-events.outputs.has-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ticketeate-svc-events
          IMAGE_TAG: ${{ needs.release-svc-events.outputs.new-version }}
        run: |
          echo "ðŸ³ Building Docker image for svc-events:$IMAGE_TAG"
          docker build \
            -f apps/svc-events/Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          echo "ðŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Successfully pushed:"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  docker-svc-producers:
    name: Build & Push svc-producers Docker
    needs: release-svc-producers
    if: needs.release-svc-producers.outputs.has-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ticketeate-svc-producers
          IMAGE_TAG: ${{ needs.release-svc-producers.outputs.new-version }}
        run: |
          echo "ðŸ³ Building Docker image for svc-producers:$IMAGE_TAG"
          docker build \
            -f apps/svc-producers/Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          echo "ðŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Successfully pushed:"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  docker-svc-checkout:
    name: Build & Push svc-checkout Docker
    needs: release-svc-checkout
    if: needs.release-svc-checkout.outputs.has-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ticketeate-svc-checkout
          IMAGE_TAG: ${{ needs.release-svc-checkout.outputs.new-version }}
        run: |
          echo "ðŸ³ Building Docker image for svc-checkout:$IMAGE_TAG"
          docker build \
            -f apps/svc-checkout/Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          echo "ðŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Successfully pushed:"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  docker-next-frontend:
    name: Build & Push next-frontend Docker
    needs: release-next-frontend
    if: needs.release-next-frontend.outputs.has-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ticketeate-web
          IMAGE_TAG: ${{ needs.release-next-frontend.outputs.new-version }}
        run: |
          echo "ðŸ³ Building Docker image for next-frontend:$IMAGE_TAG"
          docker build \
            -f Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          
          echo "ðŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "âœ… Successfully pushed:"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "   - $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  summary:
    name: Release Summary
    needs: [detect-changes, release-svc-users, release-svc-events, release-svc-producers, release-svc-checkout, release-next-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ“¦ Monorepo Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changed Projects" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.release-svc-users.outputs.has-release }}" == "true" ]; then
            echo "- âœ… **svc-users** â†’ v${{ needs.release-svc-users.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.svc-users }}" == "true" ]; then
            echo "- â„¹ï¸  **svc-users** â†’ No release (no feat/fix commits)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.release-svc-events.outputs.has-release }}" == "true" ]; then
            echo "- âœ… **svc-events** â†’ v${{ needs.release-svc-events.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.svc-events }}" == "true" ]; then
            echo "- â„¹ï¸  **svc-events** â†’ No release (no feat/fix commits)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.release-svc-producers.outputs.has-release }}" == "true" ]; then
            echo "- âœ… **svc-producers** â†’ v${{ needs.release-svc-producers.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.svc-producers }}" == "true" ]; then
            echo "- â„¹ï¸  **svc-producers** â†’ No release (no feat/fix commits)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.release-svc-checkout.outputs.has-release }}" == "true" ]; then
            echo "- âœ… **svc-checkout** â†’ v${{ needs.release-svc-checkout.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.svc-checkout }}" == "true" ]; then
            echo "- â„¹ï¸  **svc-checkout** â†’ No release (no feat/fix commits)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.release-next-frontend.outputs.has-release }}" == "true" ]; then
            echo "- âœ… **next-frontend** â†’ v${{ needs.release-next-frontend.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect-changes.outputs.next-frontend }}" == "true" ]; then
            echo "- â„¹ï¸  **next-frontend** â†’ No release (no feat/fix commits)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "All images with new versions have been pushed to ECR with both version tag and :latest tag" >> $GITHUB_STEP_SUMMARY
