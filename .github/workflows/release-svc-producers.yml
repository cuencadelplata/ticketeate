name:🚀Releasesvc-producers

on:
push:
branches:
-main
paths:
-'apps/svc-producers/**'
-'packages/**'
-'.github/workflows/release-svc-producers.yml'

permissions:
contents:write
issues:write
pull-requests:write

jobs:
analyze-commits:
name:📊Analizarcommits
runs-on:ubuntu-latest
outputs:
has-feat:${{steps.check.outputs.has-feat}}
has-fix:${{steps.check.outputs.has-fix}}
has-breaking:${{steps.check.outputs.has-breaking}}
steps:
-name:📥Checkout
uses:actions/checkout@v4
with:
fetch-depth:0

-name:🔍Revisarcommitsdesdeúltimotag
id:check
run:|
#Obtenerelúltimotagdesvc-producers
LAST_TAG=$(gittag-l"svc-producers-v*"--sort=-v:refname|head-n1)

if[-z"$LAST_TAG"];then
echo"Nohaytagsprevios,analizandotodosloscommits"
COMMITS=$(gitlog--oneline--no-merges)
else
echo"Últimotagencontrado:$LAST_TAG"
COMMITS=$(gitlog${LAST_TAG}..HEAD--oneline--no-merges--apps/svc-producerspackages)
fi

echo"Commitsaanalizar:"
echo"$COMMITS"

#Verificartiposdecommits
HAS_FEAT=$(echo"$COMMITS"|grep-E"^[a-f0-9]+feat(\([^)]*\))?:"||true)
HAS_FIX=$(echo"$COMMITS"|grep-E"^[a-f0-9]+fix(\([^)]*\))?:"||true)
HAS_BREAKING=$(echo"$COMMITS"|grep-E"BREAKINGCHANGE|!:"||true)

if[-n"$HAS_FEAT"];then
echo"has-feat=true">>$GITHUB_OUTPUT
echo"✨Encontradoscommitsdefeatures"
else
echo"has-feat=false">>$GITHUB_OUTPUT
fi

if[-n"$HAS_FIX"];then
echo"has-fix=true">>$GITHUB_OUTPUT
echo"🐛Encontradoscommitsdefixes"
else
echo"has-fix=false">>$GITHUB_OUTPUT
fi

if[-n"$HAS_BREAKING"];then
echo"has-breaking=true">>$GITHUB_OUTPUT
echo"💥Encontradosbreakingchanges"
else
echo"has-breaking=false">>$GITHUB_OUTPUT
fi

notify-breaking:
name:⚠️Notificarbreakingchanges
needs:analyze-commits
if:needs.analyze-commits.outputs.has-breaking=='true'
runs-on:ubuntu-latest
steps:
-name:📝Crearissueparabreakingchange
uses:actions/github-script@v7
with:
script:|
awaitgithub.rest.issues.create({
owner:context.repo.owner,
repo:context.repo.repo,
title:'⚠️BreakingChangedetectadoensvc-producers-RequierereleaseMAJOR',
body:`SedetectaronBREAKINGCHANGESenloscommitsrecientesde\`svc-producers\`.

##⚠️Acciónrequerida

Losbreakingchangesrequierenun**releaseMAJOR**(incrementodeversiónX.0.0).

###Opciones:

1.**Ejecutarelworkflowmanual**:Vea[ManualMajorRelease](../actions/workflows/manual-major-release.yml)yejecutaelworkflowespecificandolanuevaversiónmajor.

2.**Revertirloscommits**:Silosbreakingchangesnoeranintencionales.

##📋Commitsconbreakingchanges:

Revisaloscommitsrecientesparaidentificarlosbreakingchanges.

---
*Esteissuefuecreadoautomáticamenteporelworkflowderelease.*`,
labels:['breaking-change','svc-producers','release']
});

release:
name:🎉Crearrelease
needs:analyze-commits
if:needs.analyze-commits.outputs.has-feat=='true'||needs.analyze-commits.outputs.has-fix=='true'
runs-on:ubuntu-latest
steps:
-name:📥Checkout
uses:actions/checkout@v4
with:
fetch-depth:0
token:${{secrets.SEMANTIC_RELEASE_TOKEN}}
persist-credentials:true

-name:SetupNode.js
uses:actions/setup-node@v4
with:
node-version:'22'

-name:Instalarpnpm
run:npminstall-gpnpm@10.10.0

-name:📚Instalardependenciasdesemantic-release
run:|
cdapps/svc-producers
pnpmadd-Dsemantic-release@semantic-release/changelog@semantic-release/github@semantic-release/commit-analyzer@semantic-release/release-notes-generator@semantic-release/exec@semantic-release/git

-name:🚀Ejecutarsemantic-release
working-directory:apps/svc-producers
env:
GITHUB_TOKEN:${{secrets.GITHUB_TOKEN}}
GIT_AUTHOR_NAME:github-actions[bot]
GIT_AUTHOR_EMAIL:github-actions[bot]@users.noreply.github.com
GIT_COMMITTER_NAME:github-actions[bot]
GIT_COMMITTER_EMAIL:github-actions[bot]@users.noreply.github.com
run:npxsemantic-release
