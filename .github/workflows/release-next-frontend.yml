name:Release-TicketeateWeb

on:
push:
branches:
-main
paths:
-'apps/next-frontend/**'
-'packages/**'
-'.github/workflows/release-next-frontend.yml'

permissions:
contents:write
issues:write
pull-requests:write
repository-projects:write

jobs:
analyze-commits:
name:Analizarcommits
runs-on:ubuntu-latest
outputs:
should_release:${{steps.check.outputs.should_release}}
has_breaking:${{steps.check.outputs.has_breaking}}
steps:
-name:📥Checkout
uses:actions/checkout@v4
with:
fetch-depth:0

-name:🔍Verificartipodecambios
id:check
run:|
#Obtenercommitsdesdeelúltimotag
LAST_TAG=$(gitdescribe--tags--abbrev=02>/dev/null||echo"")
if[-z"$LAST_TAG"];then
COMMITS=$(gitlog--format=%s)
else
COMMITS=$(gitlog${LAST_TAG}..HEAD--format=%s)
fi

echo"📝Commitsaanalizar:"
echo"$COMMITS"

#Verificarsihaybreakingchanges
ifecho"$COMMITS"|grep-qE'^(feat!|fix!|perf!|refactor!|BREAKINGCHANGE)';then
echo"⚠️BREAKINGCHANGEdetectado-Noselanzaráautomáticamente"
echo"should_release=false">>$GITHUB_OUTPUT
echo"has_breaking=true">>$GITHUB_OUTPUT
elifecho"$COMMITS"|grep-qE'^(feat|fix|perf|refactor):';then
echo"✅Cambiosmenores/patchdetectados-Seprocederáconrelease"
echo"should_release=true">>$GITHUB_OUTPUT
echo"has_breaking=false">>$GITHUB_OUTPUT
else
echo"ℹ️Nohaycambiosquerequieranrelease"
echo"should_release=false">>$GITHUB_OUTPUT
echo"has_breaking=false">>$GITHUB_OUTPUT
fi

notify-breaking:
name:NotificarBreakingChange
runs-on:ubuntu-latest
needs:analyze-commits
if:needs.analyze-commits.outputs.has_breaking=='true'
steps:
-name:Checkout
uses:actions/checkout@v4

-name:💬Crearissueparamajorrelease
uses:actions/github-script@v7
with:
script:|
constissue=awaitgithub.rest.issues.create({
owner:context.repo.owner,
repo:context.repo.repo,
title:'🚨BREAKINGCHANGEdetectado-RequiereMajorReleaseManual',
body:`##⚠️BreakingChangeDetectado

Sehandetectadocambioscon\`BREAKINGCHANGE\`enloscommitsrecientes.

###📋AcciónRequerida

Una**majorrelease**(cambiodeversiónmayor)requiereaprobaciónmanual.

###🔧PasosparalanzarMajorRelease:

1.Vea**Actions**→**ManualMajorRelease**
2.Ejecutaelworkflowmanualmente
3.Revisayapruebaloscambios

###📝CommitsconBreakingChanges:

\`\`\`
${context.payload.commits.map(c=>c.message).join('\n')}
\`\`\`

---

**CommitSHA:**\`${context.sha.substring(0,7)}\`
**Branch:**\`${context.ref.replace('refs/heads/','')}\`
`,
labels:['major-release','breaking-change','needs-approval']
});

console.log(`Issuecreado:#${issue.data.number}`);

release:
name:CrearReleaseAutomático
runs-on:ubuntu-latest
needs:analyze-commits
if:needs.analyze-commits.outputs.should_release=='true'
steps:
-name:📥Checkout
uses:actions/checkout@v4
with:
fetch-depth:0
token:${{secrets.SEMANTIC_RELEASE_TOKEN}}
persist-credentials:true

-name:SetupNode.js
uses:actions/setup-node@v4
with:
node-version:'22'

-name:Instalarpnpm
run:npminstall-gpnpm@10.10.0

-name:📚Instalardependenciasdesemantic-release
run:|
cdapps/next-frontend
pnpmadd-Dsemantic-release@semantic-release/changelog@semantic-release/github@semantic-release/commit-analyzer@semantic-release/release-notes-generator@semantic-release/exec@semantic-release/git

-name:🚀Ejecutarsemantic-release
working-directory:apps/next-frontend
env:
GITHUB_TOKEN:${{secrets.GITHUB_TOKEN}}
GIT_AUTHOR_NAME:github-actions[bot]
GIT_AUTHOR_EMAIL:github-actions[bot]@users.noreply.github.com
GIT_COMMITTER_NAME:github-actions[bot]
GIT_COMMITTER_EMAIL:github-actions[bot]@users.noreply.github.com
run:npxsemantic-release

-name:✅Releasecompletado
if:success()
run:|
echo"🎉Releasecreadoexitosamente"
echo"📦VerificalanuevaversiónenGitHubReleases"
echo"🐳ElworkflowdeDockerbuildseejecutaráautomáticamenteconelnuevotag"

trigger-docker-build:
name:DockerBuildTrigger
runs-on:ubuntu-latest
needs:release
if:success()
steps:
-name:ℹ️Info
run:|
echo"✅Eltagfuecreadoexitosamente"
echo"🔄Elworkflow'BuildandPushtoECR'seejecutaráautomáticamente"
echo"📍VerificaenActions→BuildandPushTicketeateFrontendtoAWSECR"
