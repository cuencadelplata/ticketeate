name: Release - Ticketeate Web

on:
  push:
    branches:
      - main
    paths:
      - 'apps/next-frontend/**'
      - 'packages/**'
      - '.github/workflows/release-next-frontend.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze-commits:
    name: ğŸ“Š Analizar commits
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      has_breaking: ${{ steps.check.outputs.has_breaking }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Verificar tipo de cambios
        id: check
        run: |
          # Obtener commits desde el Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --format=%s)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --format=%s)
          fi
          
          echo "ğŸ“ Commits a analizar:"
          echo "$COMMITS"
          
          # Verificar si hay breaking changes
          if echo "$COMMITS" | grep -qE '^(feat!|fix!|perf!|refactor!|BREAKING CHANGE)'; then
            echo "âš ï¸ BREAKING CHANGE detectado - No se lanzarÃ¡ automÃ¡ticamente"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "has_breaking=true" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE '^(feat|fix|perf|refactor):'; then
            echo "âœ… Cambios menores/patch detectados - Se procederÃ¡ con release"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No hay cambios que requieran release"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          fi

  notify-breaking:
    name: ğŸš¨ Notificar Breaking Change
    runs-on: ubuntu-latest
    needs: analyze-commits
    if: needs.analyze-commits.outputs.has_breaking == 'true'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Crear issue para major release
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ BREAKING CHANGE detectado - Requiere Major Release Manual',
              body: `## âš ï¸ Breaking Change Detectado
              
              Se han detectado cambios con \`BREAKING CHANGE\` en los commits recientes.
              
              ### ğŸ“‹ AcciÃ³n Requerida
              
              Una **major release** (cambio de versiÃ³n mayor) requiere aprobaciÃ³n manual.
              
              ### ğŸ”§ Pasos para lanzar Major Release:
              
              1. Ve a **Actions** â†’ **Manual Major Release**
              2. Ejecuta el workflow manualmente
              3. Revisa y aprueba los cambios
              
              ### ğŸ“ Commits con Breaking Changes:
              
              \`\`\`
              ${context.payload.commits.map(c => c.message).join('\n')}
              \`\`\`
              
              ---
              
              **Commit SHA:** \`${context.sha.substring(0, 7)}\`
              **Branch:** \`${context.ref.replace('refs/heads/', '')}\`
              `,
              labels: ['major-release', 'breaking-change', 'needs-approval']
            });
            
            console.log(`Issue creado: #${issue.data.number}`);

  release:
    name: ğŸ‰ Crear Release AutomÃ¡tico
    runs-on: ubuntu-latest
    needs: analyze-commits
    if: needs.analyze-commits.outputs.should_release == 'true'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ğŸ“¦ Instalar pnpm
        run: npm install -g pnpm@10.10.0

      - name: ğŸ“š Instalar dependencias de semantic-release
        run: |
          cd apps/next-frontend
          pnpm add -D semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/npm

      - name: ğŸ” Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸš€ Ejecutar semantic-release
        working-directory: apps/next-frontend
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

      - name: âœ… Release completado
        if: success()
        run: |
          echo "ğŸ‰ Release creado exitosamente"
          echo "ğŸ“¦ Verifica la nueva versiÃ³n en GitHub Releases"
          echo "ğŸ³ El workflow de Docker build se ejecutarÃ¡ automÃ¡ticamente con el nuevo tag"

  trigger-docker-build:
    name: ğŸ³ Verificar Docker Build Trigger
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
      - name: â„¹ï¸ Info
        run: |
          echo "âœ… El tag fue creado exitosamente"
          echo "ğŸ”„ El workflow 'Build and Push to ECR' se ejecutarÃ¡ automÃ¡ticamente"
          echo "ğŸ“ Verifica en Actions â†’ Build and Push Ticketeate Frontend to AWS ECR"
